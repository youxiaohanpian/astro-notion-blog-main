---
/**
 * Mentioné“¾æ¥ç»„ä»¶
 * 
 * åŠŸèƒ½ï¼šåœ¨æ–‡æœ¬ä¸­åˆ›å»ºæŒ‡å‘å…¶ä»–Notioné¡µé¢çš„é“¾æ¥
 * 
 * æ³¨æ„äº‹é¡¹ï¼š
 * 1. éœ€è¦é€šè¿‡pageIdè·å–é“¾æ¥çš„ç›®æ ‡é¡µé¢
 * 2. æ ·å¼ä¿æŒä¸Notionä¸€è‡´
 * 3. æ˜¾ç¤ºç›®æ ‡é¡µé¢çš„å›¾æ ‡å’Œæ ‡é¢˜
 * 4. å½“é¡µé¢ä¸å­˜åœ¨æ—¶æ˜¾ç¤ºæç¤ºä¿¡æ¯
 * 
 * !!! è­¦å‘Šï¼šæ­¤ç»„ä»¶å·²è°ƒè¯•æ­£å¸¸å·¥ä½œï¼Œä¿®æ”¹å‰è¯·ç¡®ä¿å®Œå…¨ç†è§£å…¶å·¥ä½œåŸç† !!!
 */
import type { Post, Emoji, FileObject } from '../../lib/interfaces.ts'
import { getPostByPageId } from '../../lib/notion/client'
import { getPostLink } from '../../lib/blog-helpers.ts'
import '../../styles/notion-color.css'
import arrow from '../../images/icon-arrow-link.svg'

export interface Props {
  pageId: string
}

const { pageId } = Astro.props

// è·å–è¢«æåŠçš„é¡µé¢
let post: Post | null = null
if (pageId && pageId.trim() !== '') {
  try {
    post = await getPostByPageId(pageId)
    // éªŒè¯ post å¯¹è±¡æ˜¯å¦å®Œæ•´
    if (post && (!post.Slug || !post.PageId)) {
      console.warn(`Mention: Postå¯¹è±¡ä¸å®Œæ•´, pageId: ${pageId}, Slug: ${post.Slug}, PageId: ${post.PageId}`)
      post = null
    } else {
      console.log(`Mention: Found post for pageId ${pageId}:`, post ? post.Slug : 'Not found')
    }
  } catch (error) {
    console.error(`Mention: Error fetching post for pageId ${pageId}:`, error)
    post = null
  }
}
---

{
  post && post.Slug && post.Slug.trim() !== '' ? (
    <a href={getPostLink(post.Slug)} class="link">
      <span class="icon">
        {post.Icon ? (
          post.Icon.Type === 'emoji' ? (
            (post.Icon as Emoji).Emoji
          ) : (
            <img
              src={(post.Icon as FileObject).Url}
              class="notion-icon"
              alt="Post title icon in a page link"
            />
          )
        ) : (
          'ğŸ“„'
        )}
        <img src={arrow.src} class="icon-link" alt="Arrow icon of a page link" />
      </span>
      <span class="text">{post.Title}</span>
    </a>
  ) : (
    <a class="link not-found">
      <span class="icon">
        ğŸš«
        <img src={arrow.src} class="icon-link" alt="Arrow icon of a page link" />
      </span>
      <span class="text not-found">Post not found (ID: {pageId})</span>
    </a>
  )
}

<style>
  a.link {
    display: inline-flex;
    font-weight: 600;
    gap: 4px;
    color: var(--text-color);
    text-decoration: none;
    border-radius: 3px;
    padding: 0 2px;
    transition: background-color 0.2s;
  }
  a.link:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
  a.link.not-found {
    cursor: default;
    opacity: 0.7;
  }
  span.icon {
    height: fit-content;
    flex-shrink: 0;
    position: relative;
  }
  span.icon img.notion-icon {
    width: 1.3em;
    height: 1.3rem;
    vertical-align: sub;
    flex-shrink: 0;
    position: relative;
  }
  span.icon img.icon-link {
    display: block;
    position: absolute;
    top: 1em;
    right: 0;
    width: 8px;
    height: 8px;
  }
  span.text {
    color: var(--text-color);
    font-weight: 500;
    text-decoration: underline;
  }
  span.text.not-found {
    font-weight: normal;
    text-decoration: none;
  }
  .mention {
    color: var(--text-color);
  }
</style>
